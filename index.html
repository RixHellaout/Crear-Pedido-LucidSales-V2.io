<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear Pedido | LucidSales</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f7f9ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --cyan:#06b6d4;
      --ok:#16a34a;
      --bad:#dc2626;
      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --r16:16px;
      --r12:12px;
      --gap:14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: linear-gradient(180deg, #fff 0%, var(--panel) 100%);
    }

    .topbar{
      position:sticky; top:0; z-index:20;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width: 1380px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #93c5fd 0%, var(--blue) 55%, var(--blue2) 100%);
      box-shadow: 0 0 0 6px rgba(37,99,235,.10);
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      margin-top:2px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }
    .pill .swatch{
      width:10px;height:10px;border-radius:999px;
      background: var(--cyan);
      box-shadow: 0 0 0 4px rgba(6,182,212,.12);
    }

    .wrap{
      max-width: 1380px;
      margin: 0 auto;
      padding: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .stack{ display:flex; flex-direction:column; gap:18px; }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--r16);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      padding:16px 16px 12px 16px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .card-title{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .card-desc{
      margin:6px 0 0 0;
      font-size:13px;
      color:var(--muted);
      font-weight:650;
      line-height:1.35;
    }
    .card-body{ padding:16px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    @media (max-width: 720px){
      .row{ grid-template-columns: 1fr; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:7px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    input, select{
      width:100%;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 11px 12px;
      outline:none;
      font-size:14px;
      background:#fff;
      transition: .15s ease;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    input[readonly]{ background:#f8fafc; color:#334155; }

    .hint{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:650;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:900;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      line-height:1;
    }
    .btn-primary{ background: var(--blue); color:#fff; }
    .btn-primary:hover{ background: var(--blue2); }
    .btn-soft{
      background: rgba(37,99,235,.10);
      color: var(--blue2);
      border:1px solid rgba(37,99,235,.18);
    }
    .btn-soft:hover{ background: rgba(37,99,235,.14); }
    .btn-ghost{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn-ghost:hover{ background:#f8fafc; }
    .btn-danger{
      background: rgba(220,38,38,.12);
      color: var(--bad);
      border:1px solid rgba(220,38,38,.22);
      font-weight:950;
    }

    .divider{ height:1px; background: var(--border); margin: 14px 0; }

    .products{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .product{
      border:1px solid var(--border);
      border-radius: var(--r12);
      background: #f7f9fc;
      padding:12px;
    }
    .product-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .product-title{ font-weight:950; font-size:13px; }
    .mini{
      font-size:12px;
      color:var(--muted);
      font-weight:750;
      margin-top:4px;
      line-height:1.25;
    }

    .variations{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .variation{
      border:1px dashed rgba(100,116,139,.35);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .variation-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }

    .codebox{
      background:#0b1220;
      color:#e5e7eb;
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(148,163,184,.25);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      overflow:auto;
      max-height: 460px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
      line-height:1.45;
      white-space:pre;
    }

    .status{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
    }
    .badge{
      font-weight:950;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      white-space:nowrap;
    }
    .badge.ok{ color:var(--ok); border-color: rgba(22,163,74,.28); background: rgba(22,163,74,.08); }
    .badge.bad{ color:var(--bad); border-color: rgba(220,38,38,.28); background: rgba(220,38,38,.08); }
    .badge.neutral{ color:var(--muted); background: rgba(100,116,139,.08); border-color: rgba(100,116,139,.20); }

    .small-muted{ font-size:12px; color:var(--muted); font-weight:800; }

    /* Summary */
    .summary-list{
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      overflow:hidden;
    }
    .summary-head{
      display:flex;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background: #f8fafc;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      font-weight:800;
    }
    .summary-row:last-child{ border-bottom:0; }
    .summary-left{ display:flex; flex-direction:column; gap:3px; }
    .summary-name{ font-weight:950; color:var(--text); }
    .summary-sub{ font-size:12px; color:var(--muted); font-weight:750; }
    .money{ font-variant-numeric: tabular-nums; }

    .totals{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .tot-line{
      display:flex;
      justify-content:space-between;
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      font-weight:950;
      color:var(--text);
    }
    .tot-line:last-child{ border-bottom:0; }
    .tot-muted{ color:var(--muted); font-weight:900; }

    .toggle{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .radio{
      flex:1;
      min-width: 160px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      font-weight:950;
      background:#fff;
      transition:.15s ease;
    }
    .radio input{ width:auto; margin:0; }
    .radio.active{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
      background: rgba(37,99,235,.06);
    }

    .footer-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:12px 16px;
      border-top:1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
    }

    .hidden{ display:none !important; }

    /* NEW: thumbs in lists */
    .thumb{
      width:40px; height:40px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb-fallback{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      color:var(--muted);
      font-weight:900;
      background:#f8fafc;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <div>Crear Orden</div>
          <div class="sub"></div>
        </div>
      </div>
      <div class="pill"><span class="swatch" aria-hidden="true"></span> Blanco + Azul</div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="stack">
        <!-- Datos cliente -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Información del cliente</h2>
            </div>
            <div class="btns" style="margin:0;">
              <button class="btn btn-soft" type="button" id="loadProductsBtn">Cargar productos</button>
            </div>
          </div>

          <div class="card-body">
            <div class="row">
              <div class="field">
                <label for="apiKey">API Key</label>
                <input id="apiKey" autocomplete="off" />
              </div>
              <div class="field">
                <label for="shopify_order_id">shopify_order_id</label>
                <input id="shopify_order_id" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="name">Nombres</label>
                <input id="name" />
              </div>
              <div class="field">
                <label for="surname">Apellidos</label>
                <input id="surname" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="phone">Número de teléfono</label>
                <input id="phone" />
              </div>
              <div class="field">
                <label for="client_email">Correo electrónico</label>
                <input id="client_email" type="email" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="state">Departamento / Provincia</label>
                <input id="state" />
              </div>
              <div class="field">
                <label for="city">Ciudad</label>
                <input id="city" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="dir">Dirección y complementos</label>
                <input id="dir" />
              </div>
              <div class="field">
                <label for="references">Referencias</label>
                <input id="references" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="source">Canal</label>
                <select id="source">
                  <option value=""></option>
                  <option value="WhatsApp">WhatsApp</option>
                  <option value="Instagram">Instagram</option>
                  <option value="Messenger">Messenger</option>
                  <option value="Web">Web</option>
                </select>
              </div>
              <div class="field">
                <label for="lucidbot_inbox">lucidbot_inbox</label>
                <input id="lucidbot_inbox" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="ctwa">ctwa</label>
                <input id="ctwa" />
              </div>
              <div class="field">
                <label for="ad">ad</label>
                <input id="ad" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="document">document</label>
                <input id="document" />
              </div>
              <div class="field">
                <label for="notes">notes</label>
                <input id="notes" />
              </div>
            </div>

            <div class="row" style="margin-bottom:0;">
              <div class="field">
                <label for="discount">discount (string)</label>
                <input id="discount" value="0" />
              </div>
              <div class="field">
                <label for="fullname">fullname</label>
                <input id="fullname" />
              </div>
            </div>

            <!-- rate_type hidden: se controla por Método de pago -->
            <input id="rate_type" type="number" value="1" class="hidden" />
            <!-- total hidden: se calcula desde el resumen -->
            <input id="total" type="number" value="0" class="hidden" />
          </div>
        </div>

        <!-- Productos -->
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Seleccionar productos</h2>
              <p class="card-desc">
                Si un producto tiene variantes, debes elegir una variante.
              </p>
            </div>
          </div>

          <div class="card-body">
            <div class="row">
              <div class="field">
                <label for="productSelect">Producto</label>
                <select id="productSelect" disabled>
                  <option value=""></option>
                </select>
              </div>
              <div class="field">
                <label for="variantSelect">Variante</label>
                <select id="variantSelect" disabled>
                  <option value=""></option>
                </select>
                <div class="hint" id="variantHint">—</div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="selectedProductId">product_id (se envía)</label>
                <input id="selectedProductId" readonly />
              </div>
              <div class="field">
                <label for="selectedVariantId">variation_id (se envía si aplica)</label>
                <input id="selectedVariantId" readonly />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="suggestedPrice">Precio sugerido (referencia)</label>
                <input id="suggestedPrice" readonly />
                <div class="hint" id="priceHint">—</div>
              </div>
              <div class="field" style="justify-content:flex-end;">
                <label style="opacity:0;">.</label>
                <button class="btn btn-primary" type="button" id="addToOrderBtn" disabled>Agregar al pedido</button>
                <div class="hint" id="addHint"></div>
              </div>
            </div>

            <div class="divider"></div>

            <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px;">
              <div>
                <div style="font-weight:950;">Productos del pedido</div>
              </div>
            </div>

            <div id="orderProducts" class="products"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Resumen -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Resumen de la orden</h2>
          </div>
          <div class="btns" style="margin:0;">
            <button class="btn btn-soft" type="button" id="toggleJsonBtn">Mostrar JSON</button>
          </div>
        </div>

        <div class="card-body">
          <!-- Método de pago -->
          <div class="small-muted" style="margin-bottom:8px;">Método de pago</div>
          <div class="toggle" id="payToggle">
            <label class="radio active" id="pay1">
              <input type="radio" name="pay" value="1" checked />
              Con recaudo
            </label>
            <label class="radio" id="pay2">
              <input type="radio" name="pay" value="2" />
              Sin recaudo
            </label>
          </div>

          <div class="divider"></div>

          <!-- Lista -->
          <div class="summary-list">
            <div class="summary-head">
              <div>Producto</div>
              <div>Precio de venta</div>
            </div>
            <div id="summaryLines"></div>
          </div>

          <!-- Solo total -->
          <div class="totals">
            <div class="tot-line">
              <div class="tot-muted">Total a recaudar</div>
              <div class="money" id="sumTotal">$ 0</div>
            </div>
          </div>

          <div class="status" id="statusBox">
            <span class="badge neutral" id="statusBadge">SIN ENVIAR</span>
            <div class="small-muted" id="statusText">Aún no has enviado el pedido.</div>
          </div>

          <!-- JSON panel (oculto por defecto) -->
          <div id="jsonPanel" class="hidden" style="margin-top:14px;">
            <div class="divider"></div>

            <div class="btns" style="margin-top:0;">
              <button class="btn btn-ghost" type="button" id="refreshBtn">Actualizar JSON</button>
              <button class="btn btn-soft" type="button" id="copyJsonBtn">Copiar JSON</button>
            </div>

            <div class="small-muted" style="margin:14px 0 8px;">JSON del pedido</div>
            <div id="jsonBox" class="codebox">{}</div>

            <div class="small-muted" style="margin:14px 0 8px;">Respuesta productos (GET /products/)</div>
            <div id="productsRespBox" class="codebox" style="max-height:210px;">(vacío)</div>

            <!-- NEW -->
            <div class="small-muted" style="margin:14px 0 8px;">Respuesta imágenes (POST /products/images)</div>
            <div id="imagesRespBox" class="codebox" style="max-height:240px;">(vacío)</div>

            <div class="small-muted" style="margin:14px 0 8px;">Respuesta pedido (POST /orders/create)</div>
            <div id="respBox" class="codebox" style="max-height:240px;">(vacío)</div>

            <div class="small-muted" style="margin:14px 0 8px;">Respuesta hook (POST n8n)</div>
            <div id="hookRespBox" class="codebox" style="max-height:240px;">(vacío)</div>
          </div>
        </div>

        <div class="footer-actions">
          <button class="btn btn-ghost" type="button" id="cancelBtn">Cancelar</button>
          <button class="btn btn-primary" type="button" id="sendBtn">Enviar pedido</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const PRODUCTS_API_URL = "https://panel.lucidsales.co/b/api/v1/products/";
    const PRODUCT_IMAGES_API_URL = "https://panel.lucidsales.co/b/api/v1/products/images";
    const ORDER_API_URL    = "https://panel.lucidsales.co/b/api/v1/orders/create";
    const MAKE_HOOK_URL    = "https://webhookn8n.lucidbot.cloud/webhook/5adbc761-4a95-4d5e-b135-cc832002a017";

    const el = (id) => document.getElementById(id);

    const state = {
      orderProducts: [],
      apiProducts: [],
      selectedProductIdx: -1,
      selectedVariantIdx: -1,
      selectedProductHasVariants: false,
      _lastComputedFullname: "",
      // NEW: cache de imágenes: key -> firstUrl (o null)
      imagesByKey: new Map() // key: productName + '||' + stableVarsJson
    };

    function safeTrim(v){ return (v ?? "").toString().trim(); }
    function asNumber(v, fallback = 0){
      const t = safeTrim(v);
      if(t === "") return fallback;
      const n = Number(t);
      return Number.isFinite(n) ? n : fallback;
    }
    function asInt(v, fallback = 0){
      const t = safeTrim(v);
      if(t === "") return fallback;
      const n = parseInt(t, 10);
      return Number.isFinite(n) ? n : fallback;
    }
    function parseQtyBeforeX(v, fallback = 1){
      const t = safeTrim(v);
      if(t === "") return fallback;
      const m = t.match(/^\s*(\d+)\s*(?:x|×)\b/i);
      if(m) return asInt(m[1], fallback);
      return asInt(t, fallback);
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fmtMoney(n){
      const num = Number(n);
      const v = Number.isFinite(num) ? num : 0;
      try{
        return "$ " + new Intl.NumberFormat("es-CO", { maximumFractionDigits: 0 }).format(v);
      }catch{
        return "$ " + Math.round(v);
      }
    }

    function setStatus(kind, text){
      const badge = el("statusBadge");
      const statusText = el("statusText");
      badge.classList.remove("ok","bad","neutral");
      if(kind === "ok"){
        badge.classList.add("ok");
        badge.textContent = "OK";
      } else if(kind === "bad"){
        badge.classList.add("bad");
        badge.textContent = "ERROR";
      } else {
        badge.classList.add("neutral");
        badge.textContent = "SIN ENVIAR";
      }
      statusText.textContent = text;
    }

    function updateFullnameAuto(){
      const name = safeTrim(el("name").value);
      const surname = safeTrim(el("surname").value);
      const current = safeTrim(el("fullname").value);
      const computed = safeTrim([name, surname].filter(Boolean).join(" "));
      if(current === "" || current === computed || current === safeTrim(state._lastComputedFullname || "")){
        el("fullname").value = computed;
      }
      state._lastComputedFullname = computed;
    }

    function setProductsControlsEnabled(enabled){
      el("productSelect").disabled = !enabled;
      el("variantSelect").disabled = !enabled;
      el("addToOrderBtn").disabled = true;
      if(!enabled){
        el("productSelect").innerHTML = `<option value=""></option>`;
        el("variantSelect").innerHTML = `<option value=""></option>`;
        el("variantHint").textContent = "—";
        el("priceHint").textContent = "—";
        el("addHint").textContent = "";
        el("selectedProductId").value = "";
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = "";
        state.selectedProductIdx = -1;
        state.selectedVariantIdx = -1;
        state.selectedProductHasVariants = false;
      }
    }

    function normalizeProductsResponse(body){
      if(!body || typeof body !== "object") throw new Error("Respuesta no es JSON.");
      if(body.ok !== true) throw new Error("Respuesta ok != true.");
      if(!Array.isArray(body.products)) throw new Error("No existe products[] en la respuesta.");

      return body.products.map(p => (typeof p === "object" && p ? ({
        id: p.id,
        name: p.name ?? "",
        price: (typeof p.price === "number") ? p.price : p.price,
        variants: Array.isArray(p.variants) ? p.variants.map(v => (typeof v === "object" && v ? ({
          id: v.id,
          name: v.name ?? "",
          price: v.price
        }) : null)).filter(Boolean) : []
      }) : null)).filter(Boolean);
    }

    function lsProductIdFromNumericId(id){
      const n = Number(id);
      if(!Number.isFinite(n)) return "";
      return "ls-prod-" + String(n).padStart(5, "0");
    }
    function lsVariantIdFromRawId(id){
      const t = safeTrim(id);
      return t ? ("ls-var-" + t) : "";
    }

    function fillProductSelect(){
      const sel = el("productSelect");
      sel.innerHTML = `<option value=""></option>`;

      state.apiProducts.forEach((p, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = `${p.name} — ${lsProductIdFromNumericId(p.id)}`;
        sel.appendChild(opt);
      });

      el("variantSelect").innerHTML = `<option value=""></option>`;
      el("variantHint").textContent = "—";
      el("priceHint").textContent = "—";
      el("addHint").textContent = "";
      el("selectedProductId").value = "";
      el("selectedVariantId").value = "";
      el("suggestedPrice").value = "";
      state.selectedProductIdx = -1;
      state.selectedVariantIdx = -1;
      state.selectedProductHasVariants = false;
      el("addToOrderBtn").disabled = true;
    }

    function fillVariantSelect(productIdx){
      const sel = el("variantSelect");
      sel.innerHTML = "";

      const p = state.apiProducts[productIdx];
      const variants = Array.isArray(p?.variants) ? p.variants : [];
      const hasVariants = variants.length > 0;

      state.selectedProductHasVariants = hasVariants;
      state.selectedVariantIdx = -1;

      if(hasVariants){
        sel.appendChild(new Option("", ""));
        variants.forEach((v, vIdx) => {
          const opt = document.createElement("option");
          opt.value = String(vIdx);
          opt.textContent = `${v.name} — ${lsVariantIdFromRawId(v.id)}`;
          sel.appendChild(opt);
        });

        el("variantHint").textContent = "Selecciona una variante.";
        el("priceHint").textContent = "Precio por variante.";
        el("addHint").textContent = "";
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = "";
        el("addToOrderBtn").disabled = true;
        return;
      }

      sel.appendChild(new Option("(Sin variantes)", "__none__"));
      sel.value = "__none__";
      el("variantHint").textContent = "Sin variantes.";
      el("priceHint").textContent = "Puedes agregar el producto.";
      el("addHint").textContent = "";
      el("selectedVariantId").value = "";
      el("suggestedPrice").value = (typeof p.price === "number") ? String(p.price) : "";
      el("addToOrderBtn").disabled = false;
    }

    function updateSelectedProduct(){
      const pIdxStr = el("productSelect").value;
      const pIdx = pIdxStr === "" ? -1 : Number(pIdxStr);

      state.selectedProductIdx = pIdx;

      if(pIdx < 0){
        el("variantSelect").innerHTML = `<option value=""></option>`;
        el("variantHint").textContent = "—";
        el("priceHint").textContent = "—";
        el("addHint").textContent = "";
        el("selectedProductId").value = "";
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = "";
        state.selectedVariantIdx = -1;
        state.selectedProductHasVariants = false;
        el("addToOrderBtn").disabled = true;
        return;
      }

      const p = state.apiProducts[pIdx];
      el("selectedProductId").value = lsProductIdFromNumericId(p.id);
      fillVariantSelect(pIdx);
    }

    function updateSelectedVariant(){
      const pIdx = state.selectedProductIdx;
      if(pIdx < 0) return;

      const p = state.apiProducts[pIdx];
      const variants = Array.isArray(p?.variants) ? p.variants : [];
      const vVal = el("variantSelect").value;

      if(!state.selectedProductHasVariants){
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = (typeof p.price === "number") ? String(p.price) : "";
        el("addToOrderBtn").disabled = false;
        return;
      }

      if(vVal === ""){
        state.selectedVariantIdx = -1;
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = "";
        el("addToOrderBtn").disabled = true;
        return;
      }

      const vIdx = Number(vVal);
      state.selectedVariantIdx = vIdx;
      const v = variants[vIdx];

      el("selectedVariantId").value = lsVariantIdFromRawId(v?.id);
      el("suggestedPrice").value = (typeof v?.price === "number") ? String(v.price) : "";
      el("addToOrderBtn").disabled = false;
    }

    function makeOrderItemFromSelection(p, vOrNull){
      const productId = lsProductIdFromNumericId(p?.id);
      const productName = p?.name ?? "";

      if(vOrNull){
        const suggested = (typeof vOrNull?.price === "number") ? vOrNull.price : 0;
        return {
          product_id: productId,
          price: null,
          quantity: null,
          variations: [{
            variation_id: lsVariantIdFromRawId(vOrNull?.id),
            price: null,
            quantity: 1
          }],
          _meta: {
            product_name: productName,
            variant_name: vOrNull?.name ?? "",
            suggested_unit_price: suggested,
            image_url: null
          }
        };
      }

      const suggested = (typeof p?.price === "number") ? p.price : 0;

      return {
        product_id: productId,
        price: null,
        quantity: 1,
        variations: [],
        _meta: {
          product_name: productName,
          variant_name: "",
          suggested_unit_price: suggested,
          image_url: null
        }
      };
    }

    function getLineSale(item){
      const hasVars = Array.isArray(item?.variations) && item.variations.length > 0;
      let sale = 0;
      let qty = 0;

      if(hasVars){
        for(const v of (item.variations || [])){
          const q = parseQtyBeforeX(v.quantity, 1);
          qty += q;

          const vPriceRaw = v?.price;
          const vSaleUnit = (vPriceRaw === null || safeTrim(vPriceRaw) === "")
            ? (Number(item?._meta?.suggested_unit_price) || 0)
            : (Number(vPriceRaw) || (Number(item?._meta?.suggested_unit_price) || 0));

          sale += vSaleUnit * q;
        }
        return { qty, sale };
      }

      qty = parseQtyBeforeX(item?.quantity, 1);

      const pRaw = item?.price;
      const unitSale = (pRaw === null || safeTrim(pRaw) === "")
        ? (Number(item?._meta?.suggested_unit_price) || 0)
        : (Number(pRaw) || (Number(item?._meta?.suggested_unit_price) || 0));

      sale = unitSale * qty;
      return { qty, sale };
    }

    // -------- NEW: helpers imágenes ----------
    function stableVarsJson(obj){
      const o = (obj && typeof obj === "object") ? obj : {};
      const keys = Object.keys(o).sort((a,b)=>a.localeCompare(b));
      const sorted = {};
      for(const k of keys) sorted[k] = o[k];
      return JSON.stringify(sorted);
    }
    function makeImageCacheKey(productName, varsObj){
      return `${safeTrim(productName)}||${stableVarsJson(varsObj)}`;
    }

    function parseVariantVariables(variantName){
      // "Color: Negro / Talla: 42" -> {Color:"Negro", Talla:"42"}
      const name = safeTrim(variantName);
      if(!name) return {};
      const parts = name.split(/[\/|,]+/).map(s => safeTrim(s)).filter(Boolean);
      const out = {};
      for(const part of parts){
        const m = part.match(/^([^:]+)\s*:\s*(.+)$/);
        if(m){
          const k = safeTrim(m[1]);
          const v = safeTrim(m[2]);
          if(k && v && v.toLowerCase() !== "undefined") out[k] = v;
        }
      }
      return out;
    }

    function extractFirstImageUrlFromMessages(messages){
      if(!Array.isArray(messages)) return null;
      for(const m of messages){
        const url = m?.message?.attachment?.payload?.url;
        if(typeof url === "string" && safeTrim(url)) return safeTrim(url);
      }
      return null;
    }

    async function fetchProductImageFirstUrl(productName, varsObj){
      const apiKey = safeTrim(el("apiKey").value);
      if(!apiKey) return null;

      const key = makeImageCacheKey(productName, varsObj);
      if(state.imagesByKey.has(key)) return state.imagesByKey.get(key); // puede ser null

      const payload = [{ product: productName, variables: (varsObj && typeof varsObj === "object") ? varsObj : {} }];

      try{
        const res = await fetch(PRODUCT_IMAGES_API_URL, {
          method: "POST",
          headers: {
            "accept": "application/json",
            "Content-Type": "application/json",
            "Authorization": apiKey
          },
          body: JSON.stringify(payload)
        });

        const ctype = res.headers.get("content-type") || "";
        let body;
        if(ctype.includes("application/json")) body = await res.json();
        else body = await res.text();

        // mostramos la última respuesta de imágenes
        const show = (typeof body === "string") ? body : JSON.stringify(body, null, 2);
        el("imagesRespBox").textContent =
          `HTTP ${res.status}\n` +
          `content-type: ${ctype || "(no especificado)"}\n\n` +
          show;

        let firstUrl = null;
        if(res.ok && body && typeof body === "object"){
          firstUrl = extractFirstImageUrlFromMessages(body.messages);
        }

        state.imagesByKey.set(key, firstUrl || null);
        return firstUrl || null;

      }catch(err){
        // No rompemos el flujo: guardamos null
        el("imagesRespBox").textContent = String(err?.message || err);
        state.imagesByKey.set(key, null);
        return null;
      }
    }

    async function preloadAllProductImages(){
      // se dispara tras "Cargar productos": pide imágenes para cada producto (variables: {})
      const apiKey = safeTrim(el("apiKey").value);
      if(!apiKey){
        el("imagesRespBox").textContent = "Falta el API Key.";
        return;
      }
      if(!Array.isArray(state.apiProducts) || state.apiProducts.length === 0){
        el("imagesRespBox").textContent = "Primero carga productos.";
        return;
      }

      el("imagesRespBox").textContent = "(cargando imágenes de productos...)";

      const payload = state.apiProducts.map(p => ({
        product: safeTrim(p?.name),
        variables: {}
      })).filter(x => x.product);

      try{
        const res = await fetch(PRODUCT_IMAGES_API_URL, {
          method: "POST",
          headers: {
            "accept": "application/json",
            "Content-Type": "application/json",
            "Authorization": apiKey
          },
          body: JSON.stringify(payload)
        });

        const ctype = res.headers.get("content-type") || "";
        let body;
        if(ctype.includes("application/json")) body = await res.json();
        else body = await res.text();

        const show = (typeof body === "string") ? body : JSON.stringify(body, null, 2);
        el("imagesRespBox").textContent =
          `HTTP ${res.status}\n` +
          `content-type: ${ctype || "(no especificado)"}\n\n` +
          show;

        // Si el API devuelve un bloque con "messages", NO hay mapeo por producto en ese ejemplo,
        // así que aquí solo dejamos el preview. El cache se llena al agregar al pedido (llamada individual)
        // para asegurar que obtenemos la imagen correcta por producto/variables.
      }catch(err){
        el("imagesRespBox").textContent = String(err?.message || err);
      }
    }
    // ----------------------------------------

    function renderOrderProducts(){
      const wrap = el("orderProducts");
      wrap.innerHTML = "";

      if(state.orderProducts.length === 0){
        wrap.innerHTML = `<div class="hint">—</div>`;
        refreshAllPanels();
        return;
      }

      state.orderProducts.forEach((p, idx) => {
        const titleName = safeTrim(p?._meta?.product_name) || `Producto #${idx+1}`;
        const hasVars = Array.isArray(p?.variations) && p.variations.length > 0;
        const subName = safeTrim(p?._meta?.variant_name);
        const subtitle = hasVars ? (subName || "Con variación") : "Sin variaciones";

        const imgUrl = safeTrim(p?._meta?.image_url);
        const thumbHtml = imgUrl
          ? `<div class="thumb"><img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(titleName)}" loading="lazy" /></div>`
          : `<div class="thumb"><div class="thumb-fallback">SIN<br>IMAGEN</div></div>`;

        const card = document.createElement("div");
        card.className = "product";

        const productPriceDisabled = hasVars ? "readonly" : "";
        const productPriceValue = (p.price === null ? "" : String(p.price));

        card.innerHTML = `
          <div class="product-head">
            <div style="display:flex; gap:10px; align-items:flex-start;">
              ${thumbHtml}
              <div>
                <div class="product-title">${escapeHtml(titleName)}</div>
                <div class="mini">${escapeHtml(subtitle)}</div>
              </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="btn btn-danger" type="button" data-remove-item="${idx}">Quitar</button>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>product_id</label>
              <input readonly value="${escapeHtml(p.product_id)}" />
            </div>
            <div class="field">
              <label>price (producto)</label>
              <input ${productPriceDisabled}
                value="${escapeHtml(hasVars ? "" : productPriceValue)}"
                data-item-field="price" data-idx="${idx}" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>quantity</label>
              <input ${hasVars ? "readonly" : 'type="text"'}
                value="${hasVars ? "" : escapeHtml(String(p.quantity ?? 1))}"
                data-item-field="quantity" data-idx="${idx}" />
            </div>
            <div class="field">
              <label style="opacity:0;">.</label>
              <div class="hint"><span class="mono">${fmtMoney(Number(p?._meta?.suggested_unit_price) || 0)}</span></div>
            </div>
          </div>

          <div class="variations" id="vars-${idx}"></div>
        `;

        wrap.appendChild(card);

        const varsWrap = card.querySelector(`#vars-${idx}`);
        if(hasVars){
          (p.variations || []).forEach((v, vIdx) => {
            const vBox = document.createElement("div");
            vBox.className = "variation";
            vBox.innerHTML = `
              <div class="variation-head">
                <div style="font-weight:950; font-size:12px;">Variación</div>
                <button class="btn btn-danger" type="button" data-remove-variation="${idx}" data-v-idx="${vIdx}">Quitar</button>
              </div>

              <div class="row">
                <div class="field">
                  <label>variation_id</label>
                  <input readonly value="${escapeHtml(v.variation_id)}" />
                </div>
                <div class="field">
                  <label>price (variación)</label>
                  <input value="${v.price === null ? "" : escapeHtml(String(v.price))}"
                    data-var-field="price" data-idx="${idx}" data-v-idx="${vIdx}" />
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label>quantity</label>
                  <input type="text" value="${escapeHtml(String(v.quantity ?? 1))}"
                    data-var-field="quantity" data-idx="${idx}" data-v-idx="${vIdx}" />
                </div>
                <div class="field">
                  <label style="opacity:0;">.</label>
                  <div class="hint"></div>
                </div>
              </div>
            `;
            varsWrap.appendChild(vBox);
          });
        }else{
          varsWrap.innerHTML = `<div class="hint"></div>`;
        }
      });

      bindOrderEvents();
      refreshAllPanels();
    }

    function bindOrderEvents(){
      document.querySelectorAll("[data-item-field]").forEach(inp => {
        inp.oninput = () => {
          const idx = Number(inp.getAttribute("data-idx"));
          const field = inp.getAttribute("data-item-field");
          const raw = inp.value;
          const item = state.orderProducts[idx];
          if(!item) return;

          const hasVars = Array.isArray(item.variations) && item.variations.length > 0;

          if(field === "price"){
            if(hasVars){
              item.price = null;
              inp.value = "";
            }else{
              item.price = (safeTrim(raw) === "") ? null : raw;
            }
          }

          if(field === "quantity"){
            if(hasVars){
              item.quantity = null;
              inp.value = "";
            }else{
              item.quantity = parseQtyBeforeX(raw, 1);
            }
          }

          refreshAllPanels();
        };
      });

      document.querySelectorAll("[data-var-field]").forEach(inp => {
        inp.oninput = () => {
          const idx = Number(inp.getAttribute("data-idx"));
          const vIdx = Number(inp.getAttribute("data-v-idx"));
          const field = inp.getAttribute("data-var-field");
          const raw = inp.value;
          const item = state.orderProducts[idx];
          if(!item || !item.variations[vIdx]) return;

          if(field === "price"){
            item.variations[vIdx].price = (safeTrim(raw) === "") ? null : raw;
          }
          if(field === "quantity"){
            item.variations[vIdx].quantity = parseQtyBeforeX(raw, 1);
          }

          refreshAllPanels();
        };
      });

      document.querySelectorAll("[data-remove-item]").forEach(btn => {
        btn.onclick = () => {
          const idx = Number(btn.getAttribute("data-remove-item"));
          state.orderProducts.splice(idx, 1);
          renderOrderProducts();
        };
      });

      document.querySelectorAll("[data-remove-variation]").forEach(btn => {
        btn.onclick = () => {
          const idx = Number(btn.getAttribute("data-remove-variation"));
          const vIdx = Number(btn.getAttribute("data-v-idx"));
          const item = state.orderProducts[idx];
          if(!item) return;

          item.variations.splice(vIdx, 1);

          if(item.variations.length === 0){
            item.quantity = 1;
          }else{
            item.quantity = null;
          }

          renderOrderProducts();
        };
      });
    }

    function buildOrderPayload(){
      const name = safeTrim(el("name").value);
      const surname = safeTrim(el("surname").value);

      return {
        shopify_order_id: safeTrim(el("shopify_order_id").value),
        discount: safeTrim(el("discount").value) || "0",
        ctwa: safeTrim(el("ctwa").value),
        name,
        surname,
        fullname: safeTrim(el("fullname").value),
        total: asNumber(el("total").value, 0),
        document: safeTrim(el("document").value),
        client_email: safeTrim(el("client_email").value),
        phone: safeTrim(el("phone").value),
        dir: safeTrim(el("dir").value),
        city: safeTrim(el("city").value),
        state: safeTrim(el("state").value),

        products: state.orderProducts.map(p => {
          const hasVars = Array.isArray(p.variations) && p.variations.length > 0;

          return {
            product_id: safeTrim(p.product_id),
            price: hasVars ? null : ((p.price === null || safeTrim(p.price) === "") ? null : p.price),
            quantity: hasVars ? null : parseQtyBeforeX(p.quantity, 1),
            variations: hasVars ? (p.variations || []).map(v => ({
              variation_id: safeTrim(v.variation_id),
              price: (v.price === null || safeTrim(v.price) === "") ? null : v.price,
              quantity: parseQtyBeforeX(v.quantity, 1)
            })) : []
          };
        }),

        references: safeTrim(el("references").value),
        rate_type: asInt(el("rate_type").value, 1),
        notes: safeTrim(el("notes").value),
        source: safeTrim(el("source").value),
        lucidbot_inbox: safeTrim(el("lucidbot_inbox").value),
        ad: safeTrim(el("ad").value)
      };
    }

    function buildProductsOrderedText(){
      const map = new Map();

      for(const item of (state.orderProducts || [])){
        const name = safeTrim(item?._meta?.product_name);
        if(!name) continue;

        const hasVars = Array.isArray(item.variations) && item.variations.length > 0;
        let qty = 0;

        if(hasVars){
          qty = (item.variations || []).reduce((acc, v) => acc + parseQtyBeforeX(v.quantity, 1), 0);
        }else{
          qty = parseQtyBeforeX(item.quantity, 1);
        }

        map.set(name, (map.get(name) || 0) + qty);
      }

      const parts = [];
      for(const [name, qty] of map.entries()){
        parts.push(`${qty} x ${name}`);
      }
      return parts.join(", ");
    }

    function buildHookPayload(){
      const apiKey = safeTrim(el("apiKey").value);

      return {
        phone: safeTrim(el("phone").value),
        api_key: apiKey,
        first_name: safeTrim(el("name").value),
        last_name: safeTrim(el("surname").value),
        actions: [
          { action: "set_field_value", field_name: "Producto_Ordenados", value: buildProductsOrderedText() },
          { action: "set_field_value", field_name: "Total a Pagar", value: safeTrim(el("total").value) || "0" },
          { action: "set_field_value", field_name: "Ciudad", value: safeTrim(el("city").value) },
          { action: "set_field_value", field_name: "Provincia", value: safeTrim(el("state").value) },
          { action: "set_field_value", field_name: "Direccion_1", value: safeTrim(el("dir").value) }
        ]
      };
    }

    function refreshJsonPreview(){
      el("jsonBox").textContent = JSON.stringify(buildOrderPayload(), null, 2);
    }

    function renderSummary(){
      const wrap = el("summaryLines");
      wrap.innerHTML = "";

      if(state.orderProducts.length === 0){
        wrap.innerHTML = `
          <div class="summary-row">
            <div class="summary-left">
              <div class="summary-name"></div>
              <div class="summary-sub"></div>
            </div>
            <div class="money">${fmtMoney(0)}</div>
          </div>
        `;
      }else{
        for(const item of state.orderProducts){
          const name = safeTrim(item?._meta?.product_name) || "Producto";
          const varName = safeTrim(item?._meta?.variant_name);
          const { qty, sale } = getLineSale(item);

          const row = document.createElement("div");
          row.className = "summary-row";
          row.innerHTML = `
            <div class="summary-left" style="display:flex; flex-direction:row; align-items:center; gap:10px;">
              <div class="thumb" style="width:34px; height:34px; border-radius:10px;">
                ${
                  safeTrim(item?._meta?.image_url)
                    ? `<img src="${escapeHtml(item._meta.image_url)}" alt="${escapeHtml(name)}" loading="lazy" />`
                    : `<div class="thumb-fallback" style="font-size:9px;">SIN<br>IMAGEN</div>`
                }
              </div>
              <div style="display:flex; flex-direction:column; gap:3px;">
                <div class="summary-name">${escapeHtml(name)}${qty ? ` x ${escapeHtml(String(qty))}` : ""}</div>
                <div class="summary-sub">${escapeHtml(varName || (Array.isArray(item?.variations) && item.variations.length ? "Con variación" : "Sin variación"))}</div>
              </div>
            </div>
            <div class="money">${escapeHtml(fmtMoney(sale))}</div>
          `;
          wrap.appendChild(row);
        }
      }

      let sumSale = 0;
      for(const item of state.orderProducts){
        const { sale } = getLineSale(item);
        sumSale += sale;
      }

      el("sumTotal").textContent = fmtMoney(sumSale);
      el("total").value = String(Math.round(sumSale));
    }

    function refreshAllPanels(){
      renderSummary();
      refreshJsonPreview();
    }

    async function loadProducts(){
      const apiKey = safeTrim(el("apiKey").value);
      if(!apiKey){
        el("productsRespBox").textContent = "Falta el API Key.";
        setProductsControlsEnabled(false);
        return;
      }

      el("productsRespBox").textContent = "(cargando productos...)";
      el("imagesRespBox").textContent = "(pendiente)";

      try{
        const res = await fetch(PRODUCTS_API_URL, {
          method: "GET",
          headers: {
            "accept": "application/json",
            "Authorization": apiKey
          }
        });

        const contentType = res.headers.get("content-type") || "";
        let body;
        if(contentType.includes("application/json")){
          body = await res.json();
        }else{
          body = await res.text();
        }

        const show = (typeof body === "string") ? body : JSON.stringify(body, null, 2);

        el("productsRespBox").textContent =
          `HTTP ${res.status}\n` +
          `content-type: ${contentType || "(no especificado)"}\n\n` +
          show;

        if(!res.ok){
          setProductsControlsEnabled(false);
          return;
        }

        if(typeof body === "string"){
          throw new Error("La respuesta no es JSON.");
        }

        state.apiProducts = normalizeProductsResponse(body);
        fillProductSelect();
        setProductsControlsEnabled(true);

        // NEW: tras cargar productos, disparar POST /products/images con variables: {}
        await preloadAllProductImages();

      }catch(err){
        setProductsControlsEnabled(false);
        el("productsRespBox").textContent = String(err?.message || err);
      }
    }

    // NEW: ahora es async para poder pedir imagen al agregar
    async function addSelectionToOrder(){
      const pIdx = state.selectedProductIdx;
      if(pIdx < 0) return;

      const apiKey = safeTrim(el("apiKey").value);
      if(!apiKey){
        setStatus("bad", "Falta el API Key para traer imágenes.");
        return;
      }

      const p = state.apiProducts[pIdx];
      const variants = Array.isArray(p?.variants) ? p.variants : [];
      const hasVariants = variants.length > 0;

      let itemToAdd = null;
      let varsObj = {};
      let variantName = "";

      if(hasVariants){
        const vVal = el("variantSelect").value;
        if(vVal === "") return;
        const v = variants[Number(vVal)] || null;
        if(!v) return;

        variantName = safeTrim(v?.name);
        varsObj = parseVariantVariables(variantName);

        itemToAdd = makeOrderItemFromSelection(p, v);
      }else{
        varsObj = {};
        itemToAdd = makeOrderItemFromSelection(p, null);
      }

      // NEW: traer primera imagen y asignarla al item (si no hay, queda null => "Sin imagen")
      const firstUrl = await fetchProductImageFirstUrl(safeTrim(p?.name), varsObj);
      itemToAdd._meta.image_url = firstUrl || null;

      state.orderProducts.push(itemToAdd);
      renderOrderProducts();
    }

    async function sendOrder(){
      refreshAllPanels();

      const apiKey = safeTrim(el("apiKey").value);
      if(!apiKey){
        setStatus("bad", "Falta el API Key.");
        el("respBox").textContent = "Debes ingresar el API Key para enviar el pedido.";
        return;
      }

      if(state.orderProducts.length === 0){
        setStatus("bad", "Agrega al menos 1 producto.");
        el("respBox").textContent = "No hay productos en el pedido.";
        return;
      }

      for(const it of state.orderProducts){
        const hasVars = Array.isArray(it.variations) && it.variations.length > 0;
        if(hasVars){
          const ok = it.variations.every(v => safeTrim(v.variation_id) !== "");
          if(!ok){
            setStatus("bad", "Hay un ítem con variación inválida.");
            el("respBox").textContent = "Revisa: un producto con variantes debe tener variation_id.";
            return;
          }
        }
      }

      const payload = buildOrderPayload();

      setStatus("neutral", "Enviando pedido...");
      el("respBox").textContent = "(enviando pedido...)";
      el("hookRespBox").textContent = "(pendiente)";

      try{
        const res = await fetch(ORDER_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": apiKey
          },
          body: JSON.stringify(payload)
        });

        const contentType = res.headers.get("content-type") || "";
        let body;
        if(contentType.includes("application/json")){
          body = await res.json();
        }else{
          body = await res.text();
        }

        const show = (typeof body === "string") ? body : JSON.stringify(body, null, 2);

        el("respBox").textContent =
          `HTTP ${res.status}\n` +
          `content-type: ${contentType || "(no especificado)"}\n\n` +
          show;

        if(res.ok){
          setStatus("ok", `Pedido enviado (HTTP ${res.status}). Enviando hook...`);

          const hookPayload = buildHookPayload();
          el("hookRespBox").textContent = "(enviando hook...)";

          try{
            const hRes = await fetch(MAKE_HOOK_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "accept": "application/json"
              },
              body: JSON.stringify(hookPayload)
            });

            const hType = hRes.headers.get("content-type") || "";
            let hBody;
            if(hType.includes("application/json")){
              hBody = await hRes.json();
            }else{
              hBody = await hRes.text();
            }

            const hShow = (typeof hBody === "string") ? hBody : JSON.stringify(hBody, null, 2);

            el("hookRespBox").textContent =
              `HTTP ${hRes.status}\n` +
              `content-type: ${hType || "(no especificado)"}\n\n` +
              hShow;

            if(hRes.ok){
              setStatus("ok", `Pedido OK + hook OK (HTTP ${res.status} / ${hRes.status})`);
            }else{
              setStatus("bad", `Pedido OK, pero hook falló (HTTP ${hRes.status})`);
            }

          }catch(hErr){
            setStatus("bad", "Pedido OK, pero error de red/CORS al enviar hook.");
            el("hookRespBox").textContent = String(hErr?.message || hErr);
          }

        } else {
          setStatus("bad", `Error al enviar pedido (HTTP ${res.status})`);
          el("hookRespBox").textContent = "(no se envió hook porque falló el pedido)";
        }

      }catch(err){
        setStatus("bad", "Error de red o CORS al enviar pedido.");
        el("respBox").textContent = String(err?.message || err);
        el("hookRespBox").textContent = "(no se envió hook)";
      }
    }

    function bindPayToggle(){
      const p1 = el("pay1");
      const p2 = el("pay2");

      const setActive = (val) => {
        const v = String(val);
        p1.classList.toggle("active", v === "1");
        p2.classList.toggle("active", v === "2");
        el("rate_type").value = v;
        refreshAllPanels();
      };

      document.querySelectorAll('input[name="pay"]').forEach(r => {
        r.addEventListener("change", () => setActive(r.value));
      });

      setActive("1");
    }

    function bindJsonToggle(){
      const btn = el("toggleJsonBtn");
      const panel = el("jsonPanel");
      btn.onclick = () => {
        const open = panel.classList.contains("hidden");
        panel.classList.toggle("hidden", !open);
        btn.textContent = open ? "Ocultar JSON" : "Mostrar JSON";
      };
    }

    function clearAll(){
      [
        "shopify_order_id","discount","ctwa","name","surname","fullname","document","client_email","phone",
        "dir","city","state","references","notes","source","lucidbot_inbox","ad"
      ].forEach(id => { if(el(id)) el(id).value = ""; });

      el("discount").value = "0";

      document.querySelector('input[name="pay"][value="1"]').checked = true;
      el("rate_type").value = "1";
      el("pay1").classList.add("active");
      el("pay2").classList.remove("active");

      state.orderProducts = [];
      renderOrderProducts();

      setStatus("neutral", "Formulario reiniciado.");
      el("respBox").textContent = "(vacío)";
      el("hookRespBox").textContent = "(vacío)";
      el("imagesRespBox").textContent = "(vacío)";
      refreshAllPanels();
    }

    function init(){
      state.orderProducts = [];
      renderOrderProducts();
      refreshAllPanels();
      setProductsControlsEnabled(false);

      el("loadProductsBtn").onclick = loadProducts;

      el("productSelect").addEventListener("change", updateSelectedProduct);
      el("variantSelect").addEventListener("change", updateSelectedVariant);
      el("addToOrderBtn").onclick = addSelectionToOrder; // async ok

      el("sendBtn").onclick = sendOrder;

      el("refreshBtn").onclick = refreshAllPanels;

      el("copyJsonBtn").onclick = async () => {
        try{
          await navigator.clipboard.writeText(el("jsonBox").textContent || "{}");
          setStatus("ok", "JSON copiado al portapapeles.");
        }catch(e){
          setStatus("bad", "No se pudo copiar.");
        }
      };

      el("cancelBtn").onclick = clearAll;

      ["name","surname"].forEach(id => el(id).addEventListener("input", () => {
        updateFullnameAuto();
        refreshAllPanels();
      }));

      [
        "shopify_order_id","discount","ctwa","fullname","document","client_email","phone","dir","city","state",
        "references","notes","source","lucidbot_inbox","ad"
      ].forEach(id => el(id).addEventListener("input", refreshAllPanels));

      bindPayToggle();
      bindJsonToggle();

      updateFullnameAuto();
      refreshAllPanels();
    }

    init();
  </script>
</body>
</html>

