<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear Pedido | LucidSales</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f7f9ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --cyan:#06b6d4;
      --ok:#16a34a;
      --bad:#dc2626;
      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --r16:16px;
      --r12:12px;
      --gap:14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: linear-gradient(180deg, #fff 0%, var(--panel) 100%);
    }

    .topbar{
      position:sticky; top:0; z-index:20;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width: 1380px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #93c5fd 0%, var(--blue) 55%, var(--blue2) 100%);
      box-shadow: 0 0 0 6px rgba(37,99,235,.10);
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      margin-top:2px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }
    .pill .swatch{
      width:10px;height:10px;border-radius:999px;
      background: var(--cyan);
      box-shadow: 0 0 0 4px rgba(6,182,212,.12);
    }

    .wrap{
      max-width: 1380px;
      margin: 0 auto;
      padding: 18px;
    }

    /* PC-first horizontal layout */
    .grid{
      display:grid;
      grid-template-columns: 1.35fr .85fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--r16);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      padding:16px 16px 12px 16px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .card-title{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .card-desc{
      margin:6px 0 0 0;
      font-size:13px;
      color:var(--muted);
      font-weight:650;
      line-height:1.35;
    }
    .card-body{ padding:16px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    @media (max-width: 720px){
      .row{ grid-template-columns: 1fr; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:7px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    input, select{
      width:100%;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 11px 12px;
      outline:none;
      font-size:14px;
      background:#fff;
      transition: .15s ease;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    input[readonly]{ background:#f8fafc; color:#334155; }

    .hint{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      font-weight:650;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:900;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      line-height:1;
    }
    .btn-primary{ background: var(--blue); color:#fff; }
    .btn-primary:hover{ background: var(--blue2); }
    .btn-soft{
      background: rgba(37,99,235,.10);
      color: var(--blue2);
      border:1px solid rgba(37,99,235,.18);
    }
    .btn-soft:hover{ background: rgba(37,99,235,.14); }
    .btn-ghost{
      background:#fff;
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn-ghost:hover{ background:#f8fafc; }
    .btn-danger{
      background: rgba(220,38,38,.12);
      color: var(--bad);
      border:1px solid rgba(220,38,38,.22);
      font-weight:950;
    }

    .divider{ height:1px; background: var(--border); margin: 14px 0; }

    .products{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .product{
      border:1px solid var(--border);
      border-radius: var(--r12);
      background: #f7f9fc;
      padding:12px;
    }
    .product-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .product-title{ font-weight:950; font-size:13px; }
    .mini{
      font-size:12px;
      color:var(--muted);
      font-weight:750;
      margin-top:4px;
      line-height:1.25;
    }

    .variations{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .variation{
      border:1px dashed rgba(100,116,139,.35);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .variation-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }

    .codebox{
      background:#0b1220;
      color:#e5e7eb;
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(148,163,184,.25);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      overflow:auto;
      max-height: 460px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px;
      line-height:1.45;
      white-space:pre;
    }

    .status{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
    }
    .badge{
      font-weight:950;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      white-space:nowrap;
    }
    .badge.ok{ color:var(--ok); border-color: rgba(22,163,74,.28); background: rgba(22,163,74,.08); }
    .badge.bad{ color:var(--bad); border-color: rgba(220,38,38,.28); background: rgba(220,38,38,.08); }
    .badge.neutral{ color:var(--muted); background: rgba(100,116,139,.08); border-color: rgba(100,116,139,.20); }

    .small-muted{ font-size:12px; color:var(--muted); font-weight:800; }
    .footnote{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      line-height:1.45;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <div>Crear Pedido (PC)</div>
          <div class="sub">Pedido: POST https://panel.lucidsales.co/b/api/v1/orders/create</div>
        </div>
      </div>
      <div class="pill"><span class="swatch" aria-hidden="true"></span> Blanco + Azul</div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Pedido + Catálogo</h2>
            <p class="card-desc">
              Solo puedes añadir productos obtenidos del catálogo (bot field 663869).
              No hay creación manual.
            </p>
          </div>
        </div>

        <div class="card-body">
          <div class="row">
            <div class="field">
              <label for="apiKey">API Key (para ambos llamados)</label>
              <input id="apiKey" placeholder="Pega tu api key aquí" autocomplete="off" />
              <div class="hint">
                Catálogo: <span class="mono">X-ACCESS-TOKEN</span> • Pedido: <span class="mono">authorization</span>
              </div>
            </div>
            <div class="field">
              <label for="shopify_order_id">shopify_order_id</label>
              <input id="shopify_order_id" placeholder="Ej: 1234567890" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="discount">discount (string)</label>
              <input id="discount" placeholder="0" value="0" />
            </div>
            <div class="field">
              <label for="ctwa">ctwa</label>
              <input id="ctwa" placeholder="Ej: campaña / origen CTWA" />
            </div>
          </div>

          <div class="divider"></div>

          <!-- CATALOGO -->
          <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:10px;">
            <div>
              <div style="font-weight:950;">Catálogo (bot field 663869)</div>
              <div class="mini">Se toma SOLO <span class="mono">value</span> y se lista <span class="mono">catalogo_de_productos</span>.</div>
            </div>
            <button class="btn btn-soft" type="button" id="loadCatalogBtn">Cargar catálogo</button>
          </div>

          <div class="row">
            <div class="field">
              <label for="catalogProductSelect">Producto</label>
              <select id="catalogProductSelect" disabled>
                <option value="">(Carga el catálogo)</option>
              </select>
            </div>
            <div class="field">
              <label for="catalogVariantSelect">Variante</label>
              <select id="catalogVariantSelect" disabled>
                <option value="">(Selecciona un producto)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="selectedProductId">lucidsales_product_id</label>
              <input id="selectedProductId" readonly placeholder="Se llena al elegir producto" />
            </div>
            <div class="field">
              <label for="selectedVariantId">lucidsales_variant_id</label>
              <input id="selectedVariantId" readonly placeholder="Se llena al elegir variante" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="suggestedPrice">Precio sugerido (según precios_por_cantidad)</label>
              <input id="suggestedPrice" readonly placeholder="(Si existe, se mostrará aquí)" />
            </div>
            <div class="field" style="justify-content:flex-end;">
              <label style="opacity:0;">.</label>
              <button class="btn btn-primary" type="button" id="addFromCatalogBtn" disabled>Agregar al pedido</button>
              <div class="hint">Agrega el producto/variante seleccionados a la lista del pedido.</div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- DATOS CLIENTE -->
          <div class="row">
            <div class="field">
              <label for="name">name</label>
              <input id="name" placeholder="Nombre" />
            </div>
            <div class="field">
              <label for="surname">surname</label>
              <input id="surname" placeholder="Apellido" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="fullname">fullname</label>
              <input id="fullname" placeholder="Se autocompleta (puedes editarlo)" />
              <div class="hint">Se autogenera con <span class="mono">name + surname</span>.</div>
            </div>
            <div class="field">
              <label for="total">total (number)</label>
              <input id="total" type="number" step="0.01" placeholder="0" value="0" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="document">document</label>
              <input id="document" placeholder="CC / NIT / documento" />
            </div>
            <div class="field">
              <label for="client_email">client_email</label>
              <input id="client_email" type="email" placeholder="correo@dominio.com" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="phone">phone</label>
              <input id="phone" placeholder="+57..." />
            </div>
            <div class="field">
              <label for="dir">dir</label>
              <input id="dir" placeholder="Dirección" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="city">city</label>
              <input id="city" placeholder="Ciudad" />
            </div>
            <div class="field">
              <label for="state">state</label>
              <input id="state" placeholder="Departamento / Estado" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="references">references</label>
              <input id="references" placeholder="Referencias" />
            </div>
            <div class="field">
              <label for="rate_type">rate_type (number)</label>
              <input id="rate_type" type="number" step="1" placeholder="0" value="0" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="source">source</label>
              <input id="source" placeholder="Ej: whatsapp / ig / web" />
            </div>
            <div class="field">
              <label for="lucidbot_inbox">lucidbot_inbox</label>
              <input id="lucidbot_inbox" placeholder="Inbox / canal / id" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="ad">ad</label>
              <input id="ad" placeholder="Ej: nombre del anuncio" />
            </div>
            <div class="field">
              <label for="notes">notes</label>
              <input id="notes" placeholder="Notas rápidas" />
            </div>
          </div>

          <!-- PRODUCTS LIST -->
          <div style="margin-top:16px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
              <div>
                <div style="font-weight:950;">Productos del pedido</div>
                <div class="mini">
                  Solo se agregan desde el catálogo. Si dejas price vacío, se envía <span class="mono">null</span>.
                </div>
              </div>
            </div>

            <div id="products" class="products"></div>
          </div>

          <div class="btns" style="margin-top:16px;">
            <button class="btn btn-primary" type="button" id="sendBtn">Enviar pedido</button>
            <button class="btn btn-ghost" type="button" id="refreshBtn">Actualizar JSON</button>
            <button class="btn btn-soft" type="button" id="copyJsonBtn">Copiar JSON</button>
          </div>

          <div class="footnote">
            <div><b>Pedido:</b> <span class="mono">POST https://panel.lucidsales.co/b/api/v1/orders/create</span></div>
            <div>Header: <span class="mono">authorization: {api_key}</span> • Body: <span class="mono">application/json</span></div>
            <div style="margin-top:6px;"><b>Catálogo:</b> <span class="mono">GET https://panel.lucidbot.co/api/accounts/bot_fields/663869</span></div>
            <div>Header: <span class="mono">X-ACCESS-TOKEN: {api_key}</span></div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">JSON enviado y respuestas</h2>
            <p class="card-desc">Verás el JSON exacto del pedido + respuestas del catálogo y del API de pedidos.</p>
          </div>
        </div>

        <div class="card-body">
          <div class="small-muted" style="margin-bottom:8px;">JSON del pedido</div>
          <div id="jsonBox" class="codebox">{}</div>

          <div class="status" id="statusBox">
            <span class="badge neutral" id="statusBadge">SIN ENVIAR</span>
            <div class="small-muted" id="statusText">Aún no has enviado el pedido.</div>
          </div>

          <div class="small-muted" style="margin:14px 0 8px;">Respuesta del catálogo (GET bot field 663869)</div>
          <div id="catalogRespBox" class="codebox" style="max-height:240px;">(vacío)</div>

          <div class="small-muted" style="margin:14px 0 8px;">Respuesta del pedido (POST orders/create)</div>
          <div id="respBox" class="codebox" style="max-height:320px;">(vacío)</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ORDER_API_URL = "https://panel.lucidsales.co/b/api/v1/orders/create";
    const BOT_FIELD_ID = 663869;
    const CATALOG_API_URL = `https://panel.lucidbot.co/api/accounts/bot_fields/${BOT_FIELD_ID}`;

    const el = (id) => document.getElementById(id);
    const state = {
      products: [],                // ONLY from catalog
      catalogProducts: [],
      selectedCatalogProductIdx: -1,
      selectedCatalogVariantIdx: -1
    };

    function safeTrim(v){ return (v ?? "").toString().trim(); }
    function asNumber(v, fallback = 0){
      const t = safeTrim(v);
      if(t === "") return fallback;
      const n = Number(t);
      return Number.isFinite(n) ? n : fallback;
    }
    function asInt(v, fallback = 0){
      const t = safeTrim(v);
      if(t === "") return fallback;
      const n = parseInt(t, 10);
      return Number.isFinite(n) ? n : fallback;
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setStatus(kind, text){
      const badge = el("statusBadge");
      const statusText = el("statusText");
      badge.classList.remove("ok","bad","neutral");
      if(kind === "ok"){
        badge.classList.add("ok");
        badge.textContent = "OK";
      } else if(kind === "bad"){
        badge.classList.add("bad");
        badge.textContent = "ERROR";
      } else {
        badge.classList.add("neutral");
        badge.textContent = "SIN ENVIAR";
      }
      statusText.textContent = text;
    }

    function updateFullnameAuto(){
      const name = safeTrim(el("name").value);
      const surname = safeTrim(el("surname").value);
      const current = safeTrim(el("fullname").value);
      const computed = safeTrim([name, surname].filter(Boolean).join(" "));
      if(current === "" || current === computed || current === safeTrim(state._lastComputedFullname || "")){
        el("fullname").value = computed;
      }
      state._lastComputedFullname = computed;
    }

    function getSuggestedPriceFromPricesObj(pricesObj){
      if(!pricesObj || typeof pricesObj !== "object") return "";
      const entries = Object.entries(pricesObj);
      if(entries.length === 0) return "";
      const prefer = entries.find(([k]) => k.includes("1_") || k.includes("1unidad") || k.includes("1_unidad") || k.includes("1"));
      return (prefer ? prefer[1] : entries[0][1]) ?? "";
    }

    function normalizeCatalogValue(value){
      let v = value;

      if(typeof v === "string"){
        const t = v.trim();
        try{ v = JSON.parse(t); }
        catch(e){
          try{
            const t2 = t.replace(/^"+|"+$/g, "");
            v = JSON.parse(t2);
          }catch(e2){
            throw new Error("El campo value no es JSON válido (string).");
          }
        }
      }

      if(Array.isArray(v)) return { catalogo_de_productos: v };

      if(v && typeof v === "object"){
        if(Array.isArray(v.catalogo_de_productos)) return v;
        if(Array.isArray(v.catalogo)) return { catalogo_de_productos: v.catalogo };
      }

      throw new Error("El campo value no contiene catalogo_de_productos en formato esperado.");
    }

    function setCatalogControlsEnabled(enabled){
      el("catalogProductSelect").disabled = !enabled;
      el("catalogVariantSelect").disabled = !enabled;
      el("addFromCatalogBtn").disabled = !enabled;
      if(!enabled){
        el("catalogProductSelect").innerHTML = `<option value="">(Carga el catálogo)</option>`;
        el("catalogVariantSelect").innerHTML = `<option value="">(Selecciona un producto)</option>`;
        el("selectedProductId").value = "";
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = "";
        state.selectedCatalogProductIdx = -1;
        state.selectedCatalogVariantIdx = -1;
      }
    }

    function fillCatalogProductSelect(){
      const sel = el("catalogProductSelect");
      sel.innerHTML = `<option value="">(Selecciona un producto)</option>`;

      state.catalogProducts.forEach((p, idx) => {
        const name = p?.nombre_del_producto ?? `Producto ${idx+1}`;
        const id = p?.ids_integracion?.lucidsales_product_id ?? "";
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = id ? `${name} — ${id}` : name;
        sel.appendChild(opt);
      });

      el("catalogVariantSelect").innerHTML = `<option value="">(Selecciona un producto)</option>`;
      el("selectedProductId").value = "";
      el("selectedVariantId").value = "";
      el("suggestedPrice").value = "";
      state.selectedCatalogProductIdx = -1;
      state.selectedCatalogVariantIdx = -1;
    }

    function fillCatalogVariantSelect(productIdx){
      const sel = el("catalogVariantSelect");
      sel.innerHTML = "";

      const p = state.catalogProducts[productIdx];
      const variants = Array.isArray(p?.variantes) ? p.variantes : [];

      if(variants.length === 0){
        sel.innerHTML = `<option value="__none__">(Sin variante)</option>`;
        state.selectedCatalogVariantIdx = -1;
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = getSuggestedPriceFromPricesObj(p?.precios_por_cantidad) || "";
        return;
      }

      sel.appendChild(new Option("(Selecciona una variante)", ""));
      variants.forEach((v, vIdx) => {
        const vName = v?.nombre_de_la_variante ?? `Variante ${vIdx+1}`;
        const vId = v?.lucidsales_variant_id ?? "";
        const color = safeTrim(v?.color);
        const label = [vName, color ? `(${color})` : "", vId ? `— ${vId}` : ""].filter(Boolean).join(" ");
        const opt = document.createElement("option");
        opt.value = String(vIdx);
        opt.textContent = label;
        sel.appendChild(opt);
      });

      state.selectedCatalogVariantIdx = -1;
      el("selectedVariantId").value = "";
      el("suggestedPrice").value = "";
    }

    function updateSelectedCatalogInfo(){
      const pIdxStr = el("catalogProductSelect").value;
      const pIdx = pIdxStr === "" ? -1 : Number(pIdxStr);

      state.selectedCatalogProductIdx = pIdx;

      if(pIdx < 0){
        el("catalogVariantSelect").innerHTML = `<option value="">(Selecciona un producto)</option>`;
        el("selectedProductId").value = "";
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = "";
        state.selectedCatalogVariantIdx = -1;
        return;
      }

      const p = state.catalogProducts[pIdx];
      el("selectedProductId").value = p?.ids_integracion?.lucidsales_product_id ?? "";
      fillCatalogVariantSelect(pIdx);
    }

    function updateSelectedVariantInfo(){
      const pIdx = state.selectedCatalogProductIdx;
      if(pIdx < 0) return;

      const p = state.catalogProducts[pIdx];
      const variants = Array.isArray(p?.variantes) ? p.variantes : [];
      const vVal = el("catalogVariantSelect").value;

      if(vVal === "__none__"){
        state.selectedCatalogVariantIdx = -1;
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = getSuggestedPriceFromPricesObj(p?.precios_por_cantidad) || "";
        return;
      }

      if(vVal === ""){
        state.selectedCatalogVariantIdx = -1;
        el("selectedVariantId").value = "";
        el("suggestedPrice").value = "";
        return;
      }

      const vIdx = Number(vVal);
      state.selectedCatalogVariantIdx = vIdx;
      const v = variants[vIdx];
      el("selectedVariantId").value = v?.lucidsales_variant_id ?? "";
      el("suggestedPrice").value = getSuggestedPriceFromPricesObj(v?.precios_por_cantidad) || "";
    }

    function makeProductFromCatalog(p, vOrNull){
      const productId = p?.ids_integracion?.lucidsales_product_id ?? "";
      const productName = p?.nombre_del_producto ?? "";

      let variantId = "";
      let variantName = "";
      let suggested = "";

      if(vOrNull){
        variantId = vOrNull?.lucidsales_variant_id ?? "";
        variantName = vOrNull?.nombre_de_la_variante ?? "";
        suggested = getSuggestedPriceFromPricesObj(vOrNull?.precios_por_cantidad) || "";
      }else{
        suggested = getSuggestedPriceFromPricesObj(p?.precios_por_cantidad) || "";
      }

      return {
        product_id: productId,
        price: null,      // product price can be null
        quantity: null,   // can be null
        variations: [{
          variation_id: variantId,
          price: safeTrim(suggested) === "" ? null : suggested,
          quantity: 1
        }],
        _meta: { product_name: productName, variant_name: variantName }
      };
    }

    function renderProducts(){
      const wrap = el("products");
      wrap.innerHTML = "";

      if(state.products.length === 0){
        wrap.innerHTML = `<div class="hint">Aún no has agregado productos. Usa “Agregar al pedido”.</div>`;
        refreshJsonPreview();
        return;
      }

      state.products.forEach((p, idx) => {
        const titleName = safeTrim(p?._meta?.product_name) || `Producto #${idx+1}`;
        const subName = safeTrim(p?._meta?.variant_name);
        const subtitle = subName ? `${subName}` : "Sin variante";

        const card = document.createElement("div");
        card.className = "product";

        card.innerHTML = `
          <div class="product-head">
            <div>
              <div class="product-title">${escapeHtml(titleName)}</div>
              <div class="mini">${escapeHtml(subtitle)}<br/>Puedes ajustar price/quantity. Si dejas price vacío, se envía null.</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="btn btn-danger" type="button" data-remove-product="${idx}">Quitar</button>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>product_id</label>
              <input readonly value="${escapeHtml(p.product_id)}" />
              <div class="hint">Bloqueado (proviene del catálogo)</div>
            </div>
            <div class="field">
              <label>price (vacío = null)</label>
              <input placeholder="(vacío envía null)" value="${p.price === null ? "" : escapeHtml(String(p.price))}" data-p-field="price" data-p-idx="${idx}" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>quantity (vacío = null)</label>
              <input type="number" step="1" placeholder="(vacío envía null)" value="${p.quantity === null ? "" : escapeHtml(String(p.quantity))}" data-p-field="quantity" data-p-idx="${idx}" />
            </div>
            <div class="field">
              <label style="opacity:0;">.</label>
              <div class="hint">Deja vacío para enviar null.</div>
            </div>
          </div>

          <div class="variations" id="vars-${idx}"></div>
        `;

        wrap.appendChild(card);

        const varsWrap = card.querySelector(`#vars-${idx}`);
        (p.variations || []).forEach((v, vIdx) => {
          const vBox = document.createElement("div");
          vBox.className = "variation";
          vBox.innerHTML = `
            <div class="variation-head">
              <div style="font-weight:950; font-size:12px;">Variación</div>
              <button class="btn btn-danger" type="button" data-remove-variation="${idx}" data-v-idx="${vIdx}">Quitar variación</button>
            </div>

            <div class="row">
              <div class="field">
                <label>variation_id</label>
                <input readonly value="${escapeHtml(v.variation_id)}" />
                <div class="hint">Bloqueado (proviene del catálogo)</div>
              </div>
              <div class="field">
                <label>price (vacío = null)</label>
                <input placeholder="(vacío envía null)" value="${v.price === null ? "" : escapeHtml(String(v.price))}"
                  data-v-field="price" data-p-idx="${idx}" data-v-idx="${vIdx}" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>quantity (number)</label>
                <input type="number" step="1" placeholder="1" value="${escapeHtml(String(v.quantity ?? 1))}"
                  data-v-field="quantity" data-p-idx="${idx}" data-v-idx="${vIdx}" />
              </div>
              <div class="field">
                <label style="opacity:0;">.</label>
                <div class="hint">Por defecto: 1</div>
              </div>
            </div>
          `;
          varsWrap.appendChild(vBox);
        });
      });

      bindDynamicEvents();
      refreshJsonPreview();
    }

    function bindDynamicEvents(){
      document.querySelectorAll("[data-p-field]").forEach(inp => {
        inp.oninput = () => {
          const pIdx = Number(inp.getAttribute("data-p-idx"));
          const field = inp.getAttribute("data-p-field");
          if(!state.products[pIdx]) return;

          const raw = inp.value;

          if(field === "price"){
            state.products[pIdx].price = (safeTrim(raw) === "") ? null : raw;
          }
          if(field === "quantity"){
            state.products[pIdx].quantity = (safeTrim(raw) === "") ? null : asInt(raw, 0);
          }

          refreshJsonPreview();
        };
      });

      document.querySelectorAll("[data-v-field]").forEach(inp => {
        inp.oninput = () => {
          const pIdx = Number(inp.getAttribute("data-p-idx"));
          const vIdx = Number(inp.getAttribute("data-v-idx"));
          const field = inp.getAttribute("data-v-field");
          const raw = inp.value;

          const p = state.products[pIdx];
          if(!p || !p.variations[vIdx]) return;

          if(field === "price") p.variations[vIdx].price = (safeTrim(raw) === "") ? null : raw;
          if(field === "quantity") p.variations[vIdx].quantity = asInt(raw, 1);

          refreshJsonPreview();
        };
      });

      document.querySelectorAll("[data-remove-product]").forEach(btn => {
        btn.onclick = () => {
          const idx = Number(btn.getAttribute("data-remove-product"));
          state.products.splice(idx, 1);
          renderProducts();
        };
      });

      document.querySelectorAll("[data-remove-variation]").forEach(btn => {
        btn.onclick = () => {
          const pIdx = Number(btn.getAttribute("data-remove-variation"));
          const vIdx = Number(btn.getAttribute("data-v-idx"));
          const p = state.products[pIdx];
          if(!p) return;
          p.variations.splice(vIdx, 1);
          // keep at least one variation object (API expects variations array)
          if(p.variations.length === 0){
            p.variations.push({ variation_id:"", price:null, quantity:1 });
          }
          renderProducts();
        };
      });
    }

    function buildOrderPayload(){
      const name = safeTrim(el("name").value);
      const surname = safeTrim(el("surname").value);

      return {
        shopify_order_id: safeTrim(el("shopify_order_id").value),
        discount: safeTrim(el("discount").value) || "0",
        ctwa: safeTrim(el("ctwa").value),
        name,
        surname,
        fullname: safeTrim(el("fullname").value),
        total: asNumber(el("total").value, 0),
        document: safeTrim(el("document").value),
        client_email: safeTrim(el("client_email").value),
        phone: safeTrim(el("phone").value),
        dir: safeTrim(el("dir").value),
        city: safeTrim(el("city").value),
        state: safeTrim(el("state").value),

        products: state.products.map(p => ({
          product_id: safeTrim(p.product_id),
          price: (p.price === null || safeTrim(p.price) === "") ? null : p.price,
          variations: (p.variations || []).map(v => ({
            variation_id: safeTrim(v.variation_id),
            price: (v.price === null || safeTrim(v.price) === "") ? null : v.price,
            quantity: asInt(v.quantity, 1)
          })),
          quantity: (p.quantity === null || safeTrim(String(p.quantity)) === "") ? null : asInt(p.quantity, 0)
        })),

        references: safeTrim(el("references").value),
        rate_type: asInt(el("rate_type").value, 0),
        notes: safeTrim(el("notes").value),
        source: safeTrim(el("source").value),
        lucidbot_inbox: safeTrim(el("lucidbot_inbox").value),
        ad: safeTrim(el("ad").value)
      };
    }

    function refreshJsonPreview(){
      const payload = buildOrderPayload();
      el("jsonBox").textContent = JSON.stringify(payload, null, 2);
    }

    async function loadCatalog(){
      const apiKey = safeTrim(el("apiKey").value);
      if(!apiKey){
        el("catalogRespBox").textContent = "Falta el API Key.";
        setCatalogControlsEnabled(false);
        return;
      }

      el("catalogRespBox").textContent = "(cargando catálogo...)";

      try{
        const res = await fetch(CATALOG_API_URL, {
          method: "GET",
          headers: {
            "accept": "application/json",
            "X-ACCESS-TOKEN": apiKey
          }
        });

        const contentType = res.headers.get("content-type") || "";
        let body;
        if(contentType.includes("application/json")){
          body = await res.json();
        }else{
          body = await res.text();
        }

        const show = (typeof body === "string") ? body : JSON.stringify(body, null, 2);

        el("catalogRespBox").textContent =
          `HTTP ${res.status}\n` +
          `content-type: ${contentType || "(no especificado)"}\n\n` +
          show;

        if(!res.ok){
          setCatalogControlsEnabled(false);
          return;
        }

        if(typeof body === "string" || body?.value === undefined){
          throw new Error("La respuesta no tiene la propiedad 'value' en JSON.");
        }

        const catalogObj = normalizeCatalogValue(body.value);
        state.catalogProducts = Array.isArray(catalogObj.catalogo_de_productos) ? catalogObj.catalogo_de_productos : [];

        fillCatalogProductSelect();
        setCatalogControlsEnabled(true);

      }catch(err){
        setCatalogControlsEnabled(false);
        el("catalogRespBox").textContent = String(err?.message || err);
      }
    }

    async function sendOrder(){
      refreshJsonPreview();

      const apiKey = safeTrim(el("apiKey").value);
      if(!apiKey){
        setStatus("bad", "Falta el API Key.");
        el("respBox").textContent = "Debes ingresar el API Key para enviar el pedido.";
        return;
      }

      if(state.products.length === 0){
        setStatus("bad", "Agrega al menos 1 producto del catálogo.");
        el("respBox").textContent = "No hay productos en el pedido. Usa “Agregar al pedido”.";
        return;
      }

      const payload = buildOrderPayload();

      setStatus("neutral", "Enviando...");
      el("respBox").textContent = "(enviando...)";

      try{
        const res = await fetch(ORDER_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "authorization": apiKey
          },
          body: JSON.stringify(payload)
        });

        const contentType = res.headers.get("content-type") || "";
        let body;
        if(contentType.includes("application/json")){
          body = await res.json();
        }else{
          body = await res.text();
        }

        const show = (typeof body === "string") ? body : JSON.stringify(body, null, 2);

        if(res.ok){
          setStatus("ok", `Éxito (HTTP ${res.status})`);
        } else {
          setStatus("bad", `Error (HTTP ${res.status})`);
        }

        el("respBox").textContent =
          `HTTP ${res.status}\n` +
          `content-type: ${contentType || "(no especificado)"}\n\n` +
          show;

      }catch(err){
        setStatus("bad", "Error de red o CORS.");
        el("respBox").textContent = String(err?.message || err);
      }
    }

    function addFromCatalogToOrder(){
      const pIdx = state.selectedCatalogProductIdx;
      if(pIdx < 0) return;

      const p = state.catalogProducts[pIdx];
      const variants = Array.isArray(p?.variantes) ? p.variantes : [];

      let v = null;
      const vSel = el("catalogVariantSelect").value;
      if(vSel !== "" && vSel !== "__none__" && variants.length){
        v = variants[Number(vSel)] || null;
      }

      state.products.push(makeProductFromCatalog(p, v));
      renderProducts();
    }

    function init(){
      // NO default product. Only from catalog.
      state.products = [];
      renderProducts();

      el("loadCatalogBtn").onclick = loadCatalog;

      el("catalogProductSelect").addEventListener("change", () => {
        updateSelectedCatalogInfo();
        el("addFromCatalogBtn").disabled = (el("catalogProductSelect").value === "");
      });

      el("catalogVariantSelect").addEventListener("change", updateSelectedVariantInfo);

      el("addFromCatalogBtn").onclick = () => {
        if(el("catalogProductSelect").value === "") return;
        addFromCatalogToOrder();
      };

      el("sendBtn").onclick = sendOrder;
      el("refreshBtn").onclick = refreshJsonPreview;

      el("copyJsonBtn").onclick = async () => {
        try{
          await navigator.clipboard.writeText(el("jsonBox").textContent || "{}");
          setStatus("ok", "JSON copiado al portapapeles.");
        }catch(e){
          setStatus("bad", "No se pudo copiar (permiso del navegador).");
        }
      };

      ["name","surname"].forEach(id => el(id).addEventListener("input", () => {
        updateFullnameAuto();
        refreshJsonPreview();
      }));

      [
        "shopify_order_id","discount","ctwa","fullname","total","document","client_email","phone","dir","city","state",
        "references","rate_type","notes","source","lucidbot_inbox","ad"
      ].forEach(id => el(id).addEventListener("input", refreshJsonPreview));

      updateFullnameAuto();
      refreshJsonPreview();
      setCatalogControlsEnabled(false);
    }

    init();
  </script>
</body>
</html>
